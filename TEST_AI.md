# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI-—Å–µ–∫—Ä–µ—Ç–∞—Ä—è ZIMA-Dialog

## üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ó–∞–ø—É—â–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä**: `npm run dev` (–ø–æ—Ä—Ç 3000)
2. **–ó–∞–ø—É—â–µ–Ω AI-–≤–æ—Ä–∫–µ—Ä**: `npm run worker:ai` (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
3. **–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
   - `OPENAI_API_KEY` - –∫–ª—é—á OpenAI API
   - `JWT_SECRET` - —Å–µ–∫—Ä–µ—Ç –¥–ª—è JWT
   - `DATABASE_URL` - —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
   - `REDIS_HOST`, `REDIS_PORT` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Redis

## üöÄ –ü–æ—à–∞–≥–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

```bash
# 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS-–∫–æ–¥
curl -X POST http://localhost:3000/v0/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79990000000"}'

# –û—Ç–≤–µ—Ç: {"ttl":300}
# –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ —É–≤–∏–¥–∏—à—å: (DEV) SMS code for +79990000000: 1234

# 2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥ –∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
curl -X POST http://localhost:3000/v0/auth/verify \
  -H "Content-Type: application/json" \
  -d '{
    "phone":"+79990000000",
    "code":"1234",
    "deviceInfo":{
      "deviceId":"test-device-1",
      "platform":"web",
      "appVersion":"1.0.0"
    }
  }'

# –°–æ—Ö—Ä–∞–Ω–∏ ACCESS_TOKEN –∏–∑ –æ—Ç–≤–µ—Ç–∞
export ACCESS_TOKEN="<–≤–∞—à_access_token>"
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

```bash
# –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–≤—Ç–æ—Ä–∏ —à–∞–≥ 1 —Å –¥—Ä—É–≥–∏–º –Ω–æ–º–µ—Ä–æ–º)
# –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–π —á–∞—Ç
curl -X POST http://localhost:3000/v0/chats \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"userIds":["<user_id_–≤—Ç–æ—Ä–æ–≥–æ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>"]}'

# –°–æ—Ö—Ä–∞–Ω–∏ CHAT_ID –∏–∑ –æ—Ç–≤–µ—Ç–∞
export CHAT_ID="<chat_id>"
```

### –®–∞–≥ 3: –í–∫–ª—é—á–∏—Ç—å AI-—Å–µ–∫—Ä–µ—Ç–∞—Ä—è –≤ —á–∞—Ç–µ

```bash
curl -X PUT http://localhost:3000/v0/chats/$CHAT_ID/ai-settings \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ai_enabled": true,
    "ai_instructions": "–¢—ã ZIMA-Dialog ‚Äî –º–æ–π –ª–∏—á–Ω—ã–π –∫–∞—Ä–º–∞–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–∞—Ä—å. –ü–æ–º–æ–≥–∞–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å, –≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ –∏–¥–µ–π. –ï—Å–ª–∏ —è —Ñ–æ—Ä–º—É–ª–∏—Ä—É—é –º—ã—Å–ª–∏ —Ö–∞–æ—Ç–∏—á–Ω–æ, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –∏—Ö –≤ –ø—É–Ω–∫—Ç—ã. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏. –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π 1-3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞.",
    "ai_model": "gpt-4o-mini",
    "ai_temperature": 0.3
  }'
```

### –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç AI

```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
curl -X POST http://localhost:3000/v0/messages/$CHAT_ID/send \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "text",
    "text": "–ü–æ–º–æ–≥–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –Ω–∞ –∑–∞–≤—Ç—Ä–∞: –≤—Å—Ç—Ä–µ—á–∞ –≤ 10:00, –æ–±–µ–¥ –≤ 13:00, –∑–≤–æ–Ω–æ–∫ –∫–ª–∏–µ–Ω—Ç—É –≤ 15:00"
  }'

# AI-–≤–æ—Ä–∫–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞—Å—Ç –æ—Ç–≤–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç senderId='system'
# –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞: "AI job <id> completed successfully"

# –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
curl -X GET http://localhost:3000/v0/messages/$CHAT_ID \
  -H "Authorization: Bearer $ACCESS_TOKEN"

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:
# 1. –¢–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ (senderId = —Ç–≤–æ–π user_id)
# 2. –û—Ç–≤–µ—Ç AI (senderId = 'system')
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å AI-–∑–∞–¥–∞—á

```bash
# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö AI-–∑–∞–¥–∞—á
curl -X GET "http://localhost:3000/v0/ai/tasks?limit=10" \
  -H "Authorization: Bearer $ACCESS_TOKEN"

# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–¥–∞—á—É
curl -X GET "http://localhost:3000/v0/ai/tasks/<task_id>" \
  -H "Authorization: Bearer $ACCESS_TOKEN"
```

## üéØ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∂–∏–º—ã AI-—Å–µ–∫—Ä–µ—Ç–∞—Ä—è

### –†–µ–∂–∏–º "–î–µ–ª–æ–≤–æ–π —Å–µ–∫—Ä–µ—Ç–∞—Ä—å"

```json
{
  "ai_enabled": true,
  "ai_mode": "assistant",
  "ai_instructions": "–¢—ã ZIMA-Dialog ‚Äî –º–æ–π –¥–µ–ª–æ–≤–æ–π —Å–µ–∫—Ä–µ—Ç–∞—Ä—å. –ü–æ–º–æ–≥–∞–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–∞, —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç—ã –≤ –≤–µ–∂–ª–∏–≤–æ–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ. –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π —á–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∏ –∑–≤—É—á–∞–ª–∏ —è—Å–Ω–æ, –ª–æ–≥–∏—á–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö —ç–º–æ—Ü–∏–π. –û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –ª–∞–∫–æ–Ω–∏—á–Ω–æ, –ø—Ä–µ–¥–ª–∞–≥–∞—è 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ.",
  "ai_temperature": 0.2
}
```

### –†–µ–∂–∏–º "–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"

```json
{
  "ai_enabled": true,
  "ai_mode": "assistant",
  "ai_instructions": "–¢—ã ZIMA-Dialog ‚Äî –º–æ–π —Å–µ–∫—Ä–µ—Ç–∞—Ä—å –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. –ü–æ–º–æ–≥–∞–π —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º, –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Å—Ä–æ–∫–∏ –∏ —à–∞–≥–∏. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç —Å–ø–∏—Å–∫–æ–≤ –∏ –ø–æ–¥–∑–∞–¥–∞—á, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω. –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –∫—Ä–∞—Ç–∫–∏–º —Å–ø–∏—Å–∫–æ–º ¬´–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏: ‚Ä¶¬ª.",
  "ai_temperature": 0.3
}
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –õ–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:

```
Processing AI job <id> { chatId: '...', messageId: '...', senderId: '...', text: '...' }
AI job <id> completed successfully
```

### –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

1. **–¢–∞–±–ª–∏—Ü–∞ `Message`**: –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å `senderId = 'system'` –∏ `content` = –æ—Ç–≤–µ—Ç AI
2. **–¢–∞–±–ª–∏—Ü–∞ `AiJob`**: –∑–∞–ø–∏—Å—å —Å–æ `status = 'COMPLETED'` –∏ `result` = —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞

### WebSocket —Å–æ–±—ã—Ç–∏—è:

–ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω WebSocket-–∫–ª–∏–µ–Ω—Ç –∫ —á–∞—Ç—É, –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ event:
```json
{
  "type": "message_new",
  "payload": {
    "message": {
      "id": "...",
      "senderId": "system",
      "content": "–û—Ç–≤–µ—Ç AI...",
      "chatId": "...",
      "createdAt": "..."
    }
  }
}
```

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **AI-–≤–æ—Ä–∫–µ—Ä –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏**:
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤–æ—Ä–∫–µ—Ä –∑–∞–ø—É—â–µ–Ω: `npm run worker:ai`
   - –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
   - –ü—Ä–æ–≤–µ—Ä—å `OPENAI_API_KEY` –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏

2. **–û—à–∏–±–∫–∞ "Invalid code"**:
   - –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
   - –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ –≤ dev-—Ä–µ–∂–∏–º–µ

3. **AI –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç**:
   - –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
   - –£–±–µ–¥–∏—Å—å, —á—Ç–æ `ai_enabled = true` –≤ —á–∞—Ç–µ
   - –ü—Ä–æ–≤–µ—Ä—å –±–∞–ª–∞–Ω—Å OpenAI API

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (React + Socket.IO client)
2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å UI —Å API
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã AI-–æ—Ç–≤–µ—Ç–æ–≤ (‚ùÑÔ∏è –ª–æ–≥–æ—Ç–∏–ø)
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã AI —á–µ—Ä–µ–∑ UI


